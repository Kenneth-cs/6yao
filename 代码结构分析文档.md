# 六爻算卦iOS应用 - 代码结构分析文档

## 📋 目录
- [1. 项目概述](#1-项目概述)
- [2. 整体架构](#2-整体架构)
- [3. 核心模块分析](#3-核心模块分析)
- [4. 数据流向](#4-数据流向)
- [5. 网络架构](#5-网络架构)
- [6. 导航结构](#6-导航结构)
- [7. 数据持久化](#7-数据持久化)
- [8. 开发指南](#8-开发指南)

---

## 1. 项目概述

### 1.1 应用功能
- **六爻占卜**：用户输入问题，通过摇卦生成卦象，获取AI解读
- **历史记录**：保存和查看历史占卜记录
- **学习功能**：提供六爻知识学习内容
- **地理定位**：自动获取用户位置用于占卜

### 1.2 技术栈
- **框架**：SwiftUI + iOS 14+
- **数据库**：Core Data
- **网络**：URLSession + Async/Await
- **定位**：CoreLocation
- **AI服务**：豆包API (doubao-seed-1-6-thinking-250715)

---

## 2. 整体架构

### 2.1 架构模式
```
MVVM + Service Layer Architecture
├── Views (SwiftUI Views)
├── ViewModels (@StateObject, @ObservableObject)
├── Services (Business Logic)
├── Models (Data Models)
└── Persistence (Core Data)
```

### 2.2 目录结构
```
liuyao/
├── App Entry
│   └── liuyaoApp.swift                 # 应用入口
├── Views (UI层)
│   ├── ContentView.swift               # 主页面
│   ├── DivinationPageView.swift        # 问卦页面
│   ├── CoinTossPageView.swift          # 摇卦页面
│   ├── DivinationResultPageView.swift  # 解卦结果页面
│   ├── HistoryPageView.swift           # 历史记录页面
│   ├── HistoryView.swift               # 历史详情页面
│   ├── LearningPageView.swift          # 学习页面
│   └── LearningView.swift              # 学习详情页面
├── Services (业务逻辑层)
│   ├── AIService.swift                 # AI服务
│   ├── NetworkService.swift            # 网络服务
│   └── LocationManager.swift           # 定位服务
├── Models (数据模型层)
│   ├── AIModels.swift                  # AI相关模型
│   └── DataModels.swift                # 数据模型和Core Data
├── Components (共享组件)
│   └── SharedComponents.swift          # 共享UI组件
├── Resources
│   └── Assets.xcassets/                # 应用资源
└── Core Data
    └── DivinationModel.xcdatamodeld/   # Core Data模型
```

---

## 3. 核心模块分析

### 3.1 视图层 (Views)

#### ContentView.swift - 主页面
**功能**：应用主入口，包含导航和主要功能入口
```swift
- NavigationStack 管理整体导航
- 实时时间显示 (Timer + DateFormatter)
- 地理位置显示 (LocationManager)
- 主要功能入口：问卦、学习、历史
- 包含内嵌的 DivinationView 和 CoinTossView (旧版本兼容)
```

**关键状态管理**：
- `@State private var currentTime: Date`
- `@StateObject private var locationManager: LocationManager`

#### DivinationPageView.swift - 问卦页面
**功能**：用户输入问题并开始摇卦流程
```swift
- 问题输入界面 (TextField)
- 导航到摇卦页面 (NavigationLink)
- 支持默认问题预设
```

**导航流程**：
```
ContentView → DivinationPageView → CoinTossPageView
```

#### CoinTossPageView.swift - 摇卦页面
**功能**：核心摇卦逻辑和动画
```swift
- 6次抛掷动画 (State Machine)
- 摇动检测 (ShakeDetector)
- 卦象计算 (HexagramData)
- 结果页面导航 (fullScreenCover)
```

**状态机**：
```
未开始 → 开始动画 → 抛掷中 → 完成 → 显示解卦按钮
```

**关键状态**：
- `@State private var tossResults: [Bool]` - 抛掷结果
- `@State private var isAnimating: Bool` - 动画状态
- `@State private var hexagramInfo` - 卦象信息
- `@State private var showResultPage: Bool` - 控制结果页显示

#### DivinationResultPageView.swift - 解卦结果页面
**功能**：显示AI解读结果，三段式布局
```swift
- 卦象解析板块 (hexagramAnalysis)
- 问题解读板块 (questionInterpretation)  
- 建议指导板块 (guidanceAdvice)
- AI解读请求管理
- 保存到历史记录
```

**AI解读流程**：
```
页面加载 → 测试API连接 → 发送完整解读请求 → 解析响应 → 显示结果
```

### 3.2 服务层 (Services)

#### AIService.swift - AI服务
**功能**：管理与豆包API的交互
```swift
class AIService: ObservableObject {
    // 主要方法
    - testAPIConnection() -> String                    # API连接测试
    - interpretDivinationStream(...) -> DivinationResult  # 完整解读
    - interpretDivinationStream(...) -> String        # 简化解读
    - buildPrompt(...) -> String                      # 构建AI提示词
}
```

**提示词结构**：
```
作为一位资深的六爻占卜师，请为以下问题进行详细解读（当前是2025年乙巳年，9月乙酉月）：

问题：{question}

卦象信息：
- 卦名：{hexagramName}
- 卦象描述：{hexagramDescription}
- 爻位组合：{hexagramYinYang}
- 占卜时间：{timeString}（{chineseHour}）
- 占卜地点：{divinationLocation}

请按以下格式提供解读：
【卦象解析】
【问题解读】
【建议指导】
```

#### NetworkService.swift - 网络服务
**功能**：处理HTTP请求，包含重试机制
```swift
class NetworkService {
    // 网络配置
    - connectTimeout: 15秒
    - readTimeout: 120秒
    - maxRetries: 2次
    - 指数退避重试策略
    
    // 主要方法
    - sendRequest<T: Codable>(...) -> T               # 通用网络请求
    - performSingleRequest(...) -> T                  # 单次请求
    - isRetryableError(...) -> Bool                   # 重试判断
}
```

**重试策略**：
```
第1次失败 → 等待2秒 → 第2次尝试 → 等待4秒 → 第3次尝试 → 失败
```

#### LocationManager.swift - 定位服务
**功能**：获取用户地理位置
```swift
class LocationManager: ObservableObject {
    @Published var currentLocation: CLLocation?
    @Published var currentCity: String = "定位中..."
    @Published var authorizationStatus: CLAuthorizationStatus
    
    // 主要功能
    - 权限管理
    - 位置获取
    - 地址反编码 (城市名称)
}
```

### 3.3 数据模型层 (Models)

#### AIModels.swift - AI相关模型
```swift
// API响应模型
struct AIResponse: Codable {
    let choices: [Choice]
    let usage: Usage?
}

// 业务数据模型
struct DivinationResult {
    let question: String
    let tossResults: [Bool]
    let hexagramName: String
    let hexagramDescription: String
    let aiInterpretation: String
    let advice: String
    let timestamp: Date
    let divinationTime: Date
    let divinationLocation: String
}

// 卦象数据
struct HexagramData {
    let name: String
    let description: String
    static let hexagrams: [String: (name: String, description: String)] = [...]
}
```

#### DataModels.swift - 数据持久化
```swift
// Core Data 管理
class PersistenceController {
    static let shared = PersistenceController()
    let container: NSPersistentContainer
}

// 数据服务
class DataService: ObservableObject {
    - saveDivinationRecord(...)     # 保存占卜记录
    - fetchAllRecords() -> [DivinationRecord]  # 获取所有记录
    - deleteRecord(...)             # 删除记录
}

// Core Data 扩展
extension DivinationRecord {
    var tossResults: [Bool] { get set }    # JSON序列化处理
    var formattedDate: String              # 格式化日期
    var hexagramDisplay: String            # 卦象显示
}
```

---

## 4. 数据流向

### 4.1 占卜流程数据流
```
用户输入问题
    ↓
DivinationPageView (question: String)
    ↓
CoinTossPageView (question + locationManager)
    ↓
摇卦生成 tossResults: [Bool]
    ↓
HexagramData.getHexagram() → hexagramInfo
    ↓
DivinationResultPageView (question + tossResults + hexagramData + location)
    ↓
AIService.interpretDivinationStream()
    ↓
NetworkService.sendRequest() → 豆包API
    ↓
AI解读结果 → 三段式解析显示
    ↓
DataService.saveDivinationRecord() → Core Data
```

### 4.2 状态管理模式
```swift
// 页面级状态 (@State)
@State private var question: String
@State private var tossResults: [Bool]
@State private var isLoading: Bool

// 共享服务 (@StateObject/@ObservableObject)
@StateObject private var locationManager: LocationManager
@StateObject private var aiService: AIService
@StateObject private var dataService: DataService

// 环境注入 (@Environment)
@Environment(\.dismiss) private var dismiss
```

---

## 5. 网络架构

### 5.1 API配置
```swift
// 豆包API配置
private let apiKey = "9e404d1b-7d3a-420f-9a39-34ceb2dd71d6"
private let baseURL = "https://ark.cn-beijing.volces.com/api/v3/chat/completions"
private let model = "doubao-seed-1-6-thinking-250715"
```

### 5.2 请求结构
```json
{
  "model": "doubao-seed-1-6-thinking-250715",
  "messages": [
    {
      "role": "user",
      "content": "占卜提示词..."
    }
  ],
  "max_tokens": 2000,
  "temperature": 0.7
}
```

### 5.3 错误处理策略
```swift
enum NetworkError: Error {
    case invalidURL
    case encodingError
    case invalidResponse
    case serverError(Int)
    case networkError(Error)
    case noNetworkConnection
    case requestTimeout
    case connectionFailed
}

// 重试判断逻辑
- 超时错误：重试
- 5xx服务器错误：重试  
- 429请求过多：重试
- 4xx客户端错误：不重试
- 网络连接错误：重试
```

---

## 6. 导航结构

### 6.1 导航架构
```
NavigationStack (ContentView)
├── DivinationPageView (NavigationLink)
│   └── CoinTossPageView (NavigationLink)
│       └── DivinationResultPageView (fullScreenCover)
├── LearningPageView (NavigationLink)
│   └── LearningView (NavigationLink)
└── HistoryPageView (NavigationLink)
    └── HistoryView (NavigationLink)
```

### 6.2 导航方式对比
| 导航方式 | 使用场景 | 优缺点 |
|---------|----------|--------|
| NavigationLink | 标准页面跳转 | ✅ 系统导航栏 ❌ 可能有嵌套问题 |
| fullScreenCover | 模态全屏显示 | ✅ 独立导航上下文 ❌ 需手动管理关闭 |
| sheet | 模态半屏显示 | ✅ 适合表单 ❌ 空间有限 |

### 6.3 返回首页机制
```swift
// DivinationResultPageView 中的回调机制
let onDismiss: () -> Void

// CoinTossPageView 中的处理
onDismiss: {
    showResultPage = false
    DispatchQueue.main.asyncAfter(deadline: .now() + 0.1) {
        dismiss() // 返回到根视图
    }
}
```

---

## 7. 数据持久化

### 7.1 Core Data模型
```swift
// DivinationRecord Entity
- id: UUID
- question: String
- tossResultsData: Data          # JSON序列化的[Bool]数组
- aiInterpretation: String
- advice: String
- createdAt: Date
```

### 7.2 数据操作
```swift
// 保存记录
func saveDivinationRecord(
    question: String,
    tossResults: [Bool],
    aiInterpretation: String,
    advice: String
)

// 获取记录 (按时间倒序)
func fetchAllRecords() -> [DivinationRecord]

// 删除记录
func deleteRecord(_ record: DivinationRecord)
```

### 7.3 数据序列化
```swift
// [Bool] ↔ Data 转换
var tossResults: [Bool] {
    get {
        guard let data = tossResultsData else { return [] }
        return (try? JSONDecoder().decode([Bool].self, from: data)) ?? []
    }
    set {
        tossResultsData = try? JSONEncoder().encode(newValue)
    }
}
```

---

## 8. 开发指南

### 8.1 添加新功能页面

#### 步骤1：创建View文件
```swift
import SwiftUI

struct NewFeatureView: View {
    @Environment(\.dismiss) private var dismiss
    
    var body: some View {
        // UI实现
    }
}
```

#### 步骤2：添加导航
在ContentView.swift中添加NavigationLink：
```swift
NavigationLink(destination: NewFeatureView()) {
    // 按钮UI
}
```

#### 步骤3：如需数据持久化
1. 修改Core Data模型 (DivinationModel.xcdatamodeld)
2. 在DataModels.swift中添加相应的扩展
3. 在DataService中添加CRUD方法

### 8.2 修改AI解读逻辑

#### 修改提示词
在AIService.swift的`buildPrompt`方法中修改：
```swift
return """
作为一位资深的六爻占卜师，请为以下问题进行详细解读（当前是2025年乙巳年，9月乙酉月）：
// 在这里修改提示词内容
"""
```

#### 添加新的解读方法
```swift
func newInterpretationMethod(
    question: String,
    // 其他参数...
) async throws -> CustomResult {
    // 实现逻辑
}
```

### 8.3 网络请求扩展

#### 添加新的API端点
```swift
// 在NetworkService.swift中添加
func sendCustomRequest<T: Codable>(
    endpoint: String,
    body: [String: Any],
    responseType: T.Type
) async throws -> T {
    // 实现逻辑
}
```

#### 自定义错误处理
```swift
// 在NetworkError中添加新的错误类型
enum NetworkError: Error {
    // 现有错误...
    case customError(String)
}
```

### 8.4 UI组件复用

#### 使用SharedComponents
```swift
// 格式化文本显示
FormattedTextView(segments: formatAIText(content))

// 自定义文本段落
FormattedTextSegment(text: "标题", isTitle: true)
```

#### 创建新的共享组件
在SharedComponents.swift中添加：
```swift
struct CustomComponent: View {
    // 组件实现
}
```

### 8.5 调试和日志

#### 网络请求调试
```swift
print("[NetworkService] 发送请求到: \(url)")
print("[NetworkService] 请求体: \(requestBody)")
print("[NetworkService] 响应状态: \(statusCode)")
```

#### AI服务调试
```swift
print("[AIService] 开始AI解读...")
print("[AIService] 解读完成，长度: \(result.count)")
```

#### 页面导航调试
```swift
print("[ViewName] 页面被加载")
print("[ViewName] 按钮被点击")
print("[ViewName] 导航到下一页")
```

---

## 9. 性能优化建议

### 9.1 网络优化
- ✅ 已实现重试机制
- ✅ 已实现超时控制
- 🔄 可考虑添加请求缓存
- 🔄 可考虑添加请求队列管理

### 9.2 UI性能
- ✅ 使用@State最小化重绘
- ✅ 卦象信息缓存避免重复计算
- 🔄 可考虑图片懒加载
- 🔄 可考虑长列表虚拟化

### 9.3 内存管理
- ✅ 使用weak self避免循环引用
- ✅ 及时取消网络监控
- 🔄 可考虑添加内存警告处理

---

## 10. 测试策略

### 10.1 单元测试重点
- NetworkService的重试逻辑
- AIService的提示词构建
- HexagramData的卦象计算
- DataService的CRUD操作

### 10.2 集成测试重点
- 完整的占卜流程
- 网络请求和响应处理
- Core Data数据持久化
- 地理位置获取和使用

### 10.3 UI测试重点
- 导航流程的完整性
- 用户交互的响应性
- 错误状态的显示
- 数据加载状态的处理

---

## 📝 总结

本文档详细分析了六爻算卦iOS应用的代码结构，涵盖了架构设计、核心模块、数据流向、网络架构等各个方面。开发者可以基于此文档：

1. **理解现有架构**：快速掌握应用的整体设计思路
2. **扩展新功能**：按照既定模式添加新的功能模块
3. **优化性能**：基于分析结果进行针对性优化
4. **维护代码**：遵循现有的代码组织和命名规范

建议开发者在进行功能开发前，先阅读相关模块的代码实现，确保新功能与现有架构的一致性。
