import Foundation

// MARK: - AI API 响应模型
struct AIResponse: Codable {
    let choices: [Choice]
    let usage: Usage?
}

struct Choice: Codable {
    let message: Message
    let finishReason: String?
    
    enum CodingKeys: String, CodingKey {
        case message
        case finishReason = "finish_reason"
    }
}

struct Message: Codable {
    let role: String
    let content: String
}

struct Usage: Codable {
    let promptTokens: Int
    let completionTokens: Int
    let totalTokens: Int
    
    enum CodingKeys: String, CodingKey {
        case promptTokens = "prompt_tokens"
        case completionTokens = "completion_tokens"
        case totalTokens = "total_tokens"
    }
}

// MARK: - 卦象数据模型
struct DivinationResult {
    let question: String
    let tossResults: [Bool]
    let hexagramName: String
    let hexagramDescription: String
    let aiInterpretation: String
    let advice: String
    let timestamp: Date
    let divinationTime: Date  // 起卦时间
    let divinationLocation: String  // 起卦地点
    
    // 获取卦象的二进制表示
    var hexagramBinary: String {
        return tossResults.map { $0 ? "1" : "0" }.joined()
    }
    
    // 获取卦象的阴阳表示
    var hexagramYinYang: String {
        return tossResults.map { $0 ? "阳" : "阴" }.joined(separator: "-")
    }
    
    // 获取农历时间显示
    var lunarTimeString: String {
        let formatter = DateFormatter()
        formatter.dateFormat = "yyyy年MM月dd日 HH:mm"
        let timeString = formatter.string(from: divinationTime)
        
        // 获取时辰
        let hour = Calendar.current.component(.hour, from: divinationTime)
        let chineseHour = getChineseHour(hour: hour)
        
        return "\(timeString) (\(chineseHour)时)"
    }
    
    // 获取中文时辰
    private func getChineseHour(hour: Int) -> String {
        let hours = ["子", "丑", "寅", "卯", "辰", "巳", "午", "未", "申", "酉", "戌", "亥"]
        let index = (hour + 1) / 2 % 12
        return hours[index]
    }
}

// MARK: - 六十四卦数据
struct HexagramData {
    let name: String
    let description: String
    
    static let hexagrams: [String: (name: String, description: String)] = [
        "111111": ("乾为天", "纯阳之卦，象征天、创造与刚健。意味着强大的力量和无限潜能，但需谨记物极必反，刚健不息的同时也要避免刚愎自用。"),
        "000000": ("坤为地", "纯阴之卦，象征地、包容与柔顺。德行宽广，厚德载物。强调柔顺辅佐，静守持重，以柔克刚。"),
        "100010": ("水雷屯", "云雷交加，万物初生，充满艰难。象征初生、艰难。宜建立诸侯，但不可轻动，应积蓄力量，坚毅行动。"),
        "010001": ("山水蒙", "山下出泉，水气朦胧，启蒙发智。象征蒙昧、启蒙。君子应以果敢的行为培育品德，教育重在诱导与身教。"),
        "111010": ("水天需", "云（水）升于天，待时降雨。象征等待、时机。前方有险，不可贸然前进，应耐心等待，坚守正道则终吉。"),
        "010111": ("天水讼", "天西转与水东流，背道而驰。象征争讼、纠纷。告诫人们慎始免争，一旦卷入争执，以中和为贵，适可而止。"),
        "010000": ("地水师", "地中有水，聚众成师。象征军队、战争、众。强调师出有名，纪律严明，并需有德高望重之人统领方能成功。"),
        "000010": ("水地比", "水在地上，亲密无间。象征亲附、比和。九五阳刚中正，为群阴所亲附，吉祥。但应亲附贤者，慎始善终。"),
        "111011": ("风天小畜", "风行天上，密云不雨。象征小的蓄积、暂时停顿。阳气被阴气稍稍蓄积，力量不足，降雨尚待时机，宜于修养等待。"),
        "110111": ("天泽履", "上天下泽，尊卑有别，循礼而行。象征实践、履行。如同踩虎尾般危险，唯有小心谨慎，循礼而行，方可化险为夷。"),
        "111000": ("地天泰", "地在上天在下，阴阳交合，万物通泰。象征通达、安泰、和谐。是盛世之象，但泰极否来，居安思危方能长久。"),
        "000111": ("天地否", "天在上地在下，阴阳不交，万物不通。象征闭塞、阻滞的时期，宜守静待时，不可妄动。"),
        "101111": ("天火同人", "天与火，光明向上，志同道合。象征团结、协作。利于汇聚众人之力，攻克难关，但需心胸宽广，无私心。"),
        "111101": ("火天大有", "火在天上，普照万物，大获所有。象征大有所获、富有。君子应遏恶扬善，顺应天道，保持谦逊方能保有财富。"),
        "001000": ("地山谦", "地中有山，山高地卑，却藏于地下。象征谦虚、卑下。君子取多补少，称物平施。谦逊之道，亨通终身。"),
        "000100": ("雷地豫", "雷出地奋，万物欣欣向荣。象征愉悦、安乐。利于建立诸侯、出兵行动，但需顺情而动，不可乐极生悲。"),
        "100110": ("泽雷随", "泽中有雷，雷伏泽中，随时休息。象征随从、跟随。天下随时，君子应依时作息。随从之道在於使人悦服，守正则吉。"),
        "011001": ("山风蛊", "山下有风，风被山阻，流通不畅而腐败。象征腐败、革新。拯弊治乱，拨乱反正，虽有艰险，终能亨通。"),
        "110000": ("地泽临", "地高于泽，泽容于地，居高临下。象征监督、领导。君子应教化、保育万民，并时刻反省自身。"),
        "000011": ("风地观", "风行地上，观览万物。象征观察、展示。君王观民设教，臣民观君德行。观天之神道，而四时不忒，重在诚敬。"),
        "100101": ("火雷噬嗑", "火雷相交，如口中咬合食物。象征咬合、排除障碍。利于处理狱事，消除障碍，需刚柔相济，果断坚决。"),
        "101001": ("山火贲", "山下有火，火光装饰山峦。象征装饰、美化。贲卦亨通，但只是小利，应注重本质，勿流于虚文浮饰。"),
        "000001": ("山地剥", "山附于地，风雨剥蚀。象征剥落、侵蚀。阴盛阳衰，小人得势，君子应顺应时势，隐忍待机，不可有所行动。"),
        "100000": ("地雷复", "雷在地中，一阳复生。象征回复、复兴。是黑暗过后的第一缕曙光，生机重现，凡事盼头，应顺势而动。"),
        "100111": ("天雷无妄", "天下雷行，万物不敢虚妄。象征真实、不虚伪。行事要顺乎自然，守正为本，出乎意料的好运或灾祸皆因妄动而生。"),
        "111001": ("山天大畜", "天藏于山中，所畜至大。象征大有积蓄、阻止。既指积蓄才德，也指阻止乾阳的躁进，厚积薄发，利涉大川。"),
        "100001": ("山雷颐", "山下有雷，春雷一动，万物颐养。象征颐养、自食其力。观察事物的颐养之道，当以正道自求口实。"),
        "011110": ("泽风大过", "泽灭木，水淹没了树木，太过常分。象征大的过度、非常行动。栋梁弯曲，危机四伏，需以非常手段应对，独立不惧。"),
        "010010": ("坎为水", "两水相叠，险陷重重。象征险陷、坎坷。水流而不盈，行险而不失其信。维心亨，乃以刚中也。习教事，反复练习可渡险关。"),
        "101101": ("离为火", "两火相叠，光明相继。象征依附、光明与美丽。利贞，亨通。如同火焰必须依附于可燃之物，人也需依附于正道方能成功。"),
        "001110": ("泽山咸", "山上有泽，山泽通气，相互感应。象征感应、夫妇之道。以虚受人，天地感而万物化生。强调以真诚的感情相互感应。"),
        "011100": ("雷风恒", "雷动风随，持之以恒。象征恒久、稳定。天地之道，恒久不已。立身处世应有持之以恒的精神，但需守正不移。"),
        "001111": ("天山遁", "天下有山，山势逼天，天则退避。象征退隐、逃避。君子应知时而退，明哲保身，以待来日。"),
        "111100": ("雷天大壮", "雷声响彻天际，声势浩大。象征强盛、壮大。阳气虽盛，已过半程，切忌过分强硬，应知止而行。"),
        "000101": ("火地晋", "太阳出于地上，前进光明。象征前进、晋升。君子应如太阳般自昭明德，柔进上行，得以晋升，前程光明。"),
        "101000": ("地火明夷", "太阳（火）沉入地底，光明受伤。象征黑暗、挫折。君子于黑暗时期应韬光养晦，守持正固，以待黎明。"),
        "101011": ("风火家人", "风自火出，外风助内火，家道之象。象征家庭、家人。君子言有物而行有恒。女主内，男主外，各守本分，家道正而天下定。"),
        "110101": ("火泽睽", "火向上烧，泽向下浸，二者相背。象征背离、乖离。万物睽而其事同，求同存异是处理对立关系的根本。"),
        "001010": ("水山蹇", "山上有水，水路受阻，山高水险。象征险阻、艰难。利西南不利东北，见险而能止，知矣哉！当反身修德以待时。"),
        "010100": ("雷水解", "雷雨交作，天地解冻。象征解脱、缓解。利于从险难中解脱出来，抓住时机，解除困难，走向舒坦。"),
        "110001": ("山泽损", "山下有泽，泽水浸蚀山基。象征减损、损失。损下益上，但应损而有度，损益盈虚，与时偕行。"),
        "100011": ("风雷益", "风雷相助，其势愈增。象征增益、利益。损上益下，民悦无疆。利于有所前往，利涉大川。见善则迁，有过则改。"),
        "111110": ("泽天夬", "泽水化气升于天，决降成雨。象征决断、果决。五阳决一阴，君子道长，小人道忧。宜于宣扬于王庭，但需警惕用武。"),
        "011111": ("天风姤", "天下有风，风行天下，无所不遇。象征相遇、邂逅。阴爻初生，预示着不期而遇的机缘，但也暗藏阴柔势力的蔓延。"),
        "000110": ("泽地萃", "泽在地上，聚水成沼。象征汇聚、聚集。君王至庙祭祀，聚人以享。但大聚之时易生乱，须备兵器以防不测。"),
        "011000": ("地风升", "地中生出树木，不断成长。象征上升、成长。强调柔顺而依时上升，积小成大，前程远大。"),
        "010110": ("泽水困", "泽中无水，困窘之象。象征困穷、受困。君子处困之时，应致命遂志。虽困于身，而道亨通，守正可获吉祥。"),
        "011010": ("水风井", "木上有水，如井水滋养于人。象征水井、滋养不变。村邑可变，井道不移。君子应劳民劝相，修身养德，惠人无穷。"),
        "101110": ("泽火革", "泽中有火，水灭火又生火，变革之象。象征变革、革新。天地革而四时成。顺天应人，改革之时机至为亨通。"),
        "011101": ("火风鼎", "木上有火，烹任用鼎。象征鼎新、稳固。鼎器革新食物，喻指去故立新，权力稳固。君子应正位凝命。"),
        "100100": ("震为雷", "双雷相叠，震动不息。象征震动、行动与惊醒。雷声令人恐惧，从而反省致福；也喻指巨变与动荡，需从容应对。"),
        "001001": ("艮为山", "两山重叠，稳重静止。象征停止、静止。教导人们当止则止，思不出其位，抑制邪欲，内心宁静。"),
        "001011": ("风山渐", "山上有木，树木在山上渐渐成长。象征渐进、循序渐进。女子出嫁，依礼而行则吉祥。进得位，往有功，不可躁进。"),
        "110100": ("雷泽归妹", "震长男娶兑少女，非正配。象征婚嫁，但也喻指不正当的结合或行为。名不正则言不顺，前进有凶险。"),
        "101100": ("雷火丰", "雷电交加，盛大光明。象征丰盛、盛大。盛极必衰，在丰大的时刻，更需警惕忧患，持中守正，保其光明。"),
        "001101": ("火山旅", "火在山上，火势流动不止。象征旅行、不安定。身处异乡，宜守正持柔，明慎用刑，不可贪图享乐，斤斤计较。"),
        "011011": ("巽为风", "两风相随，顺从无阻。象征顺从、进入。君子应申命行事，以柔克刚。柔顺因其位，小亨，利有攸往，利见大人。"),
        "110110": ("兑为泽", "两泽相连，互相滋润。象征喜悦、言说。君子应朋友讲习，以真诚的言行使人喜悦，自己也喜悦，亨通利贞。"),
        "010011": ("风水涣", "风行水上，冰释涣散。象征涣散、消散。君王以至诚享祭立庙，凝聚人心。利于渡过大河巨川，化险为夷。"),
        "110010": ("水泽节", "泽上有水，容量有限，需加以节制。象征节制、制度。天地有节而成四时。制数度，议德行。苦节不可贞，适中为贵。"),
        "110011": ("风泽中孚", "泽上有风，风吹泽水，诚信感于内外。象征诚信、信实。诚信如孵卵，不容半点虚假。利于涉越险阻，坚守正道则吉。"),
        "001100": ("雷山小过", "山上有雷，雷声被阻，其声稍小。象征小的过度。可做小事，不可做大事；宜下不宜上，行为须谨慎收敛。"),
        "101010": ("水火既济", "水在火上，烹任已成。象征已完成、成功。事虽成，但初吉终乱。君子思患而豫防之，防微杜渐以保成功。"),
        "010101": ("火水未济", "火在水上，难以相济。象征未完成、事未成。虽然形势不明，但阴阳各得其位，蕴含着向既济转化的可能，慎辨物居方。")
    ]
    
    static func getHexagram(for binary: String) -> (name: String, description: String) {
        return hexagrams[binary] ?? ("未知卦象", "卦象信息未找到")
    }
    
    // 新增方法：根据布尔数组获取卦象数据
    static func getHexagram(for tossResults: [Bool]) -> HexagramData? {
        let binary = tossResults.map { $0 ? "1" : "0" }.joined()
        let hexagram = getHexagram(for: binary)
        return HexagramData(name: hexagram.name, description: hexagram.description)
    }
}